<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Tool</title>
        <link rel="icon" href="./favicon.ico" type="image/x-icon">

        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script> <!-- CSV reader -->
        <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script> <!-- pnorm -->
    </head>
    <body>
        <div class="demographics">
            <h1>Demographics</h1>
            <div class="input">
                <label for="age">Age (years)</label>
                <input type="number" id="age" name="age" min="0" max="120" required>
            </div>
            <div class="input">
                <label for="sex">Sex</label>
                <select name="sex" id="sex">
                    <option value="m">M</option>
                    <option value="f">F</option>
                </select>
            </div>
            <div class="input">
                <label for="height">Height (Meters)</label>
                <input type="number" id="height" name="height" min="0" max="3" required>
            </div>
        </div>
        <div class="measurements">
            <h1>Measurements</h1>
            <button onclick="addInput()">Add Measurement</button>
            <div id="measurement-inputs"></div>
        </div>
        <div class="submitdiv">
            <h1>Submit</h1>
            <button onclick="submit()">Submit</button>
        </div>
        <div id="results-container">
            <h2>Results</h2>
            <div id="results"></div>
        </div>
    </body>
</html>

<template id="measurement-input-template">
    <div class="measurement-input-group">
        <select name="structure" onchange="updateMetrics(this)">
            <option value="Body">Body</option>
            <option value="Abdomen">Abdomen</option>
            <option value="Upper Abdomen">Upper Abdomen</option>
            <option value="Pelvis">Pelvis</option>
            <option value="Thorax">Thorax</option>
            <option value="L3 Area">L3 Area</option>
        </select>
        <select name="metric">
            <option value="SAT">SAT (L/dm3)</option>
            <option value="VAT">VAT (L/dm3)</option>
            <option value="Muscle">SM (L/dm3)</option>
            <option value="SMFF">SMFF (%)</option>
            <option value="IMAT">IMAT (L/dm3)</option>
        </select>
        <input type="number" name="metric-value" placeholder="Value">
        <button type="button" class="remove-input">Remove</button>
    </div>
</template>


<script>
function addInput() {
    const template = document.getElementById('measurement-input-template');
    const clone = document.importNode(template.content, true);
    const removeButton = clone.querySelector('.remove-input');
    removeButton.addEventListener('click', function() {
        this.parentNode.remove();
    });
    document.getElementById('measurement-inputs').appendChild(clone);
}

function updateMetrics(selectElement) {
    const metricSelect = selectElement.nextElementSibling;
    const isL3Area = selectElement.value === 'L3 Area';
    
    metricSelect.innerHTML = '';
    
    const metrics = isL3Area 
        ? [
            {value: 'SAT', text: 'SAT (cm2)'},
            {value: 'VAT', text: 'VAT (cm2)'},
            {value: 'Muscle', text: 'SM (cm2)'},
            {value: 'SMFF', text: 'SMFF (%)'},
            {value: 'IMAT', text: 'IMAT (cm2)'}
          ]
        : [
            {value: 'SAT', text: 'SAT (L/dm3)'},
            {value: 'VAT', text: 'VAT (L/dm3)'},
            {value: 'Muscle', text: 'SM (L/dm3)'},
            {value: 'SMFF', text: 'SMFF (%)'},
            {value: 'IMAT', text: 'IMAT (L/dm3)'}
          ];
    
    metrics.forEach(metric => {
        const option = document.createElement('option');
        option.value = metric.value;
        option.textContent = metric.text;
        metricSelect.appendChild(option);
    });
}

function submit() {
    // Collect values
    const ageInput = document.querySelector('input[name="age"]').value;
    const sex = document.querySelector('select[name="sex"]').value;
    const heightInput = document.querySelector('input[name="height"]').value;
    
    // Convert age and height to appropriate types and apply rounding
    const age = Math.round(Number(ageInput));
    const height = Number(heightInput).toFixed(2);
    
    // Validate provided values and ranges
    if (!ageInput || !sex || !heightInput) {
        alert("Age, sex, and height must be provided.");
        return;
    }
    if (isNaN(age) || age < 20 || age > 83) {
        alert("Age must be between 20 and 83 inclusive.");
        return;
    }
    if (isNaN(height) || height < 1.40 || height > 2.08) {
        alert("Height must be between 1.40 and 2.08 meters inclusive.");
        return;
    }
    
    // Initialize an array to hold measurements and check for at least one measurement
    const measurements = [];
    const metricSelects = document.querySelectorAll('select[name="metric"]');
    metricSelects.forEach(select => {
        const metricValue = select.nextElementSibling.value; // Assuming the next element is the input for the metric value
        if (metricValue) { // Check if a measurement value is provided
            const metricName = select.options[select.selectedIndex].text;
            measurements.push(`${metricName}: ${metricValue}`);
        }
    });
    
    if (measurements.length === 0) {
        alert("At least one measurement must be provided.");
        return;
    }
    
    document.getElementById('results').innerHTML = ''; // Clear previous results
    
    // Load CSV file
    Papa.parse(`data/${age}.csv`, {
        download: true,
        header: true,
        encoding: 'UTF-8',
        complete: function(results) {
            const data = results.data;
            
            // Process each measurement
            const measurementInputs = document.querySelectorAll('.measurement-input-group');
            measurementInputs.forEach(input => {
                const structure = input.querySelector('select[name="structure"]').value;
                const metric = input.querySelector('select[name="metric"]').value;
                const value = input.querySelector('input[name="metric-value"]').value;

                if (value) {
                    // Find matching entry in CSV data
                    const matchingEntry = data.find(entry => 
                        entry.Measure === metric &&
                        entry.Structure === structure &&
                        entry.Sex === (sex === 'm' ? 'male' : 'female') &&
                        Number(entry.Age) === age &&
                        Math.abs(Number(entry.Height) - Number(height)) < 0.01 // Allow for small floating point differences
                    );

                    if (matchingEntry) {
                        const mean = Number(matchingEntry.Mean);
                        const variance = Number(matchingEntry.Variance);
                        const ptile = jStat.normal.cdf(Number(value), mean, Math.sqrt(variance));

                        // Create a result string
                        const resultString = `${structure} - ${metric}: Value = ${value}, Mean = ${mean.toFixed(2)}, Variance = ${variance.toFixed(2)}, Percentile = ${(ptile * 100).toFixed(2)}%`;
                        
                        // Create a new paragraph element for this result
                        const resultElement = document.createElement('p');
                        resultElement.textContent = resultString;
                        
                        // Add the result to the results container
                        document.getElementById('results').appendChild(resultElement);

                        console.log(resultString); // Keep the console log for debugging
                    } else {
                        const noMatchString = `No matching entry found for ${structure} - ${metric}`;
                        console.log(noMatchString);
                        // Display this message on the page as well
                        const noMatchElement = document.createElement('p');
                        noMatchElement.textContent = noMatchString;
                        document.getElementById('results').appendChild(noMatchElement);
                    }
                }
            });
        }
    });
}
</script>